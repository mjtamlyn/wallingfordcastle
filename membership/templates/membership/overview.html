{% extends 'base.html' %}

{% block content %}

{% if members %}
<div class="members">
    {% for member in members %}
    <div class="members__member">
        <h3 class="members__heading members__heading--main">{{ member }}</h3>
        <div class="members__sections">
            <div class="members__section">
                <h4 class="members__heading">Upcoming bookings</h4>
                <div class="members__section__content">
                    {% for booking in member.upcoming_bookings %}
                        <div class="members__booking">
                            <div class="members__booking__title">
                                {% if booking.is_group %}{{ booking.group_name }}{% else %}Open session{% endif %}
                            </div>
                            <div>{{ booking.start|date:"D jS M g:ia" }}</div>
                            <div><a href="{{ booking.booking_template.venue.get_absolute_url }}">{{ booking.booking_template.venue }}</a></div>
                        </div>
                    {% empty %}
                    <p>You are not currently booked for any shooting in the next week.</p>
                    <p>We hope to see you soon.</p>
                    {% endfor %}
                </div>
                <div class="members__section__actions">
                    <a class="members__action members__action--primary" href="{% url 'membership:range-booking' %}">Book</a>
                    <a class="members__action" href="{% url 'membership:member-attendance' member_id=member.pk %}">Attendance</a>
                </div>
            </div>
            <div class="members__section">
                <h4 class="members__heading">Coaching group</h4>
                <div class="members__section__content">
                    {% if member.coaching_group %}
                        <p>
                        You are currently a member of
                        <strong>{{ member.coaching_group.group_name }}</strong>,
                        meeting on
                        {{ member.coaching_group.get_session_day_display }}s 
                        between {{ member.coaching_group.session_start_time }}
                        and {{ member.coaching_group.session_end_time }} at
                        {{ member.coaching_group.venue }}.
                        </p>
                        {% with member.coaching_group.coaches.all as coaches %}
                        <p>Your coach{{ coaches|pluralize:"es" }} {{ coaches|pluralize:"is,are" }} {% for coach in coaches %}{{ coach }}{% if not forloop.last %}, {% endif%}{% endfor %}.</p>
                        {% endwith %}
                        <p>Your next scheduled session is on {{ member.coaching_group.next_session.start|date:"jS F" }}.</p>
                    {% else %}
                        <p>You are not currently a member of a coaching group.</p>
                    {% endif %}
                </div>
                <div class="members__section__actions">
                    {% if member.coaching_group %}
                        <a class="members__action members__action--primary" href="{% url 'coaching:group-schedule' group=member.coaching_group.slug %}">View schedule</a>
                    {% else %}
                        <a class="members__action" href="mailto:hello@wallingfordcastle.co.uk">Enquire about joining</a>
                    {% endif %}
                </div>
            </div>
            <div class="members__section">
                <h4 class="members__heading">Membership information</h4>
                <div class="members__section__content">
                    <dl>
                        <dt>Age Group</dt>
                        <dd>{{ member.archer.get_age_display }} {% if member.archer.date_of_birth %}({{ member.archer.date_of_birth }}){% endif %}</dd>
                        <dt>Membership</dt>
                        <dd>{{ member.get_membership_type_display }}</dd>
                        <dt>Monthly fee</dt>
                        <dd>£{{ member.plan_cost }}</dd>
                    </dl>
                </div>
                <div class="members__section__actions">
                    <a class="members__action members__action--primary" href="{% url 'membership:member-update' member_id=member.pk %}">Edit</a>
                </div>
            </div>
            {% if member.achievements %}
                <div class="members__section">
                    <h4 class="members__heading">Achievements</h4>
                    <div class="members__section__content">
                        <p>You have earned the following badges:</p>
                        <ul>
                            {% for achievement in member.achievements %}
                            <li>{{ achievement.get_badge_display }} {% if achievement.date_awarded %}<small>{{ achievement.date_awarded }}</small>{% endif %}</li>
                            {% endfor %}
                        </ul>
                    </div>
                </div>
            {% endif %}
        </div>
    </div>
    {% endfor %}
</div>
{% endif %}

{% if beginners %}
<h2>Beginners courses</h2>
<div class="table-wrapper">
    <table>
        <thead>
            <tr>
                <th>Name</th>
                <th>Age</th>
                <th>Dates</th>
                <th>Fee</th>
                <th>Paid</th>
            </tr>
        </thead>
        <tbody>
            {% for beginner in beginners %}
            <tr>
                <td>{{ beginner.name }}</td>
                <td>{{ beginner.get_age_display }} {% if beginner.date_of_birth %}({{ beginner.date_of_birth }}){% endif %}</td>
                <td>
                    {% if beginner.course %}
                        {% for session in beginner.course.beginnerscoursesession_set.all %}
                        {{ session.time_string }}<br>
                        {% endfor %}
                    {% elif beginner.is_fast_track %}
                        Fast track course
                    {% else %}
                        No course dates yet
                    {% endif %}
                </td>
                <td>£{{ beginner.fee }}</td>
                <td>{{ beginner.paid|yesno:"Yes,No" }}</td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
</div>

{% if beginners_to_pay %}
<h2>Pay £{{ beginners_to_pay }}</h2>
<form action="{% url 'beginners:payment' %}" method="POST">
    {% csrf_token %}
    <script
        src="https://checkout.stripe.com/checkout.js" class="stripe-button"
        data-key="{{ STRIPE_KEY }}"
        data-email="{{ user.email }}"
        data-currency="GBP"
        data-amount="{{ beginners_to_pay }}00"
        data-name="Wallingford Castle Archers"
        data-description="Beginners courses"
        data-locale="auto">
    </script>
</form>
{% endif %}
{% endif %}

{% if trials or course_attendees or bookable_courses %}
<h2>Coaching</h2>
{% endif %}

{% if trials %}
<h3>Trials</h3>
{% for trial in trials %}
<p><strong>{{ trial.archer }}</strong> is booked in for a trial of <strong>{{ trial.group.group_name }}</strong>.
<h4>Sessions</h4>
{{ trial.session_1|date:"jS F Y, g:i a" }}<br />
{{ trial.session_2|date:"jS F Y, g:i a" }}<br />
{{ trial.session_3|date:"jS F Y, g:i a" }}<br />
{{ trial.session_4|date:"jS F Y, g:i a" }}<br />
<p>The sessions will take place at <a href="{{ trial.group.venue.get_absolute_url }}">{{ trial.group.venue }}</a>.</p>
{% if trial.paid %}<p><small>✅ £{{ trial.fee }} paid</small></p>{% endif %}
{% endfor %}

{% if trials_to_pay %}
<p>
<a class="btn btn--narrow" href="{% url 'coaching:trial-payment' %}">Pay £{{ trials_to_pay }}</a>
</p>
{% endif %}
{% endif %}

{% if course_attendees or bookable_courses %}
<h3>Courses</h3>
{% endif %}
{% if course_attendees %}
<div class="table-wrapper">
    <table>
        <thead>
            <tr>
                <th>Name</th>
                <th>Member</th>
                <th>Course</th>
                <th>Fee</th>
                <th>Paid</th>
            </tr>
        </thead>
        <tbody>
            {% for attendee in course_attendees %}
            <tr>
                <td>{{ attendee.archer.name }}</td>
                <td>{{ attendee.member|yesno:"Yes,No" }}</td>
                <td>{{ attendee.course }}</td>
                <td>£{{ attendee.fee }}</td>
                <td>{{ attendee.paid|yesno:"Yes,No" }}</td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
</div>
{% endif %}

{% if course_fees_to_pay %}
<h4>You have £{{ course_fees_to_pay }} outstanding to pay for courses</h4>
<form action="{% url 'courses:non-members-payment' %}" method="POST">
    {% csrf_token %}
    <script
        src="https://checkout.stripe.com/checkout.js" class="stripe-button"
        data-key="{{ STRIPE_KEY }}"
        data-email="{{ user.email }}"
        data-currency="GBP"
        data-amount="{{ course_fees_to_pay }}00"
        data-name="Wallingford Castle Archers"
        data-description="{{ courses_to_pay_description }}"
        data-locale="auto">
    </script>
</form>
{% endif %}

{% if bookable_courses %}
    {% if members %}
        <p>
        <a href="{% url 'courses:members-course-list' %}">Book a club member on a course ></a>
        </p>
    {% else %}
        <p>
        <a href="{% url 'courses:non-members-course-list' %}">Book a new course ></a>
        </p>
    {% endif %}
{% endif %}

{% if members %}
    <h2>Events</h2>
    <p>
        <a href="{% url 'events:event-list' %}">Book a club event ></a>
    </p>

    <h2>Club clothing</h2>
    <p>
        <a href="https://goo.gl/forms/ONbSdBXwgpzdTSbm1">Order ></a>
    </p>

    {% if monthly_fee %}
    {% if user.customer_id %}
    <h2>Update your payment details</h2>
    {% else %}
    <h2>Add your payment details</h2>
    {% endif %}
    <p>Monthly charge: £{{ monthly_fee }}</p>
    <form action="{% url 'membership:payment-details' %}" method="POST">
        {% csrf_token %}
        <script
            src="https://checkout.stripe.com/checkout.js" class="stripe-button"
            data-key="{{ STRIPE_KEY }}"
            data-email="{{ user.email }}"
            data-currency="GBP"
            data-amount="{{ monthly_fee }}00"
            data-name="Wallingford Castle Archers"
            data-description="Club Membership (monthly)"
            data-locale="auto">
        </script>
    </form>
    <p><small>
    Payments are processed securely using Stripe. Wallingford Castle Archers does
    not store your credit card details. You will be billed monthly for all the
    membership associated with your account. If you have any problems, please
    contact the committee. Charges will be shown on your account as WALLINGFORD C.
    ARCHERS.
    </small></p>
    {% endif %}
{% endif %}

{% endblock content %}
